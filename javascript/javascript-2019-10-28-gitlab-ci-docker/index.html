<!DOCTYPE html>
<html lang>
  <head><meta name="generator" content="Hexo 3.8.0">
    
<!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width,user-scalable=no,initial-scale=1,minimum-scale=1,maximum-scale=1">


<meta name="google-site-verification" content="ZPpg1XKRwaiB4lPx6SawBAA96ROVlVBmZ8s6pigFEVc">



<meta name="naver-site-verification" content="a31e494cb7e78d5a64696ea234dc6c9006b251ff">



<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">


<meta property="og:type" content="website">
<meta property="og:url" content="https://parkdoyeon.github.io/javascript/javascript-2019-10-28-gitlab-ci-docker/">


  <meta property="og:title" content="npm 빌드위한 docker gitlab CI 세팅 삽질기">




  <meta name="description" content="npm 빌드위한 docker gitlab CI 세팅 삽질기">
  <meta property="og:description" content="npm 빌드위한 docker gitlab CI 세팅 삽질기">





  <meta name="keywords" content="docker,javascript,node,npm,gitlab,ci,container,">





  <link rel="alternate" href="/atom.xml" title="Park Doyeon">




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=">



<link rel="canonical" href="https://parkdoyeon.github.io/javascript/javascript-2019-10-28-gitlab-ci-docker/">


<meta name="description" content="vue.js를 프로덕션에 도입하면서 빌드와 배포를 하는 파이프라인 구축이 필요했다. 젠킨스와 깃랩을 함께 사용할수도 있었겠지만, 기존에 설정되어있는 깃랩 CI를 확장해 도커 깃랩 러너를 통해 npm 빌드를 하는 환경구성을 해보기로 했다. How Togitlab runner docker로 설치하고, 설정파일 생성하기  참고 - 깃랩 러너 설치 가이드  doc">
<meta name="keywords" content="docker,javascript,node,npm,gitlab,ci,container">
<meta property="og:type" content="article">
<meta property="og:title" content="npm 빌드위한 docker gitlab CI 세팅 삽질기">
<meta property="og:url" content="https://parkdoyeon.github.io/javascript/javascript-2019-10-28-gitlab-ci-docker/index.html">
<meta property="og:site_name" content="Park Doyeon">
<meta property="og:description" content="vue.js를 프로덕션에 도입하면서 빌드와 배포를 하는 파이프라인 구축이 필요했다. 젠킨스와 깃랩을 함께 사용할수도 있었겠지만, 기존에 설정되어있는 깃랩 CI를 확장해 도커 깃랩 러너를 통해 npm 빌드를 하는 환경구성을 해보기로 했다. How Togitlab runner docker로 설치하고, 설정파일 생성하기  참고 - 깃랩 러너 설치 가이드  doc">
<meta property="og:locale" content="default">
<meta property="og:updated_time" content="2020-02-23T01:34:13.472Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="npm 빌드위한 docker gitlab CI 세팅 삽질기">
<meta name="twitter:description" content="vue.js를 프로덕션에 도입하면서 빌드와 배포를 하는 파이프라인 구축이 필요했다. 젠킨스와 깃랩을 함께 사용할수도 있었겠지만, 기존에 설정되어있는 깃랩 CI를 확장해 도커 깃랩 러너를 통해 npm 빌드를 하는 환경구성을 해보기로 했다. How Togitlab runner docker로 설치하고, 설정파일 생성하기  참고 - 깃랩 러너 설치 가이드  doc">


<link rel="stylesheet" type="text/css" href="/css/style.css?v=">
<link href="https://fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet">





<script type="text/javascript">
  var themeConfig = {
    fancybox: {
      enable: false
    },
  };
</script>




  

  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-141653278-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-141653278-1');
  </script>





  


    <title> npm 빌드위한 docker gitlab CI 세팅 삽질기 - Park Doyeon </title><!-- hexo-inject:begin --><!-- hexo-inject:end -->
  </head>

  <body>
    <!-- hexo-inject:begin --><!-- hexo-inject:end --><div id="page">
      <header id="masthead"><div class="site-header-inner">
    <h1 class="site-title">
        <a href="/." class="logo">Park Doyeon</a>
    </h1>

    <nav id="nav-top">
        
            <ul id="menu-top" class="nav-top-items">
                
                    <li class="menu-item">
                        <a href="/about">
                            
                            
                                About
                            
                        </a>
                    </li>
                
            </ul>
        
  </nav>
</div>
      </header>

      <div id="post-categories"><ul class="category-list">

    <li>
    
        <a href="/csharp">C#</a>
    
    </li>

    <li>
    
        <a href="/elixir">Elixir</a>
    
    </li>

    <li>
    
        <a href="/elk">ELK</a>
    
    </li>

    <li>
    
        <a href="/javascript" class="on">JavaScript</a>
    
    </li>

    <li>
    
        <a href="/dev-env">Dev-Env</a>
    
    </li>

    <li>
    
        <a href="/ml">ML</a>
    
    </li>

    <li>
    
        <a href="/python">Python</a>
    
    </li>

    <li>
    
        <a href="/sql">SQL</a>
    
    </li>

    <li>
    
        <a href="/web">Web</a>
    
    </li>

</ul>

      </div>

      <div id="content">
        
    <div id="primary">
        
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          npm 빌드위한 docker gitlab CI 세팅 삽질기
        
      </h1>

      <time class="post-time">
          Oct 28 2019
      </time>
    </header>



    
            <div class="post-content">
            <p>vue.js를 프로덕션에 도입하면서 빌드와 배포를 하는 파이프라인 구축이 필요했다. 젠킨스와 깃랩을 함께 사용할수도 있었겠지만, 기존에 설정되어있는 깃랩 CI를 확장해 도커 깃랩 러너를 통해 npm 빌드를 하는 환경구성을 해보기로 했다.</p>
<h1 id="How-To"><a href="#How-To" class="headerlink" title="How To"></a>How To</h1><p>gitlab runner docker로 설치하고, 설정파일 생성하기</p>
<blockquote>
<p>참고 - <a href="https://docs.gitlab.com/runner/install/" rel="external nofollow noopener noreferrer" target="_blank">깃랩 러너 설치 가이드</a></p>
</blockquote>
<pre><code>docker pull gitlab/gitlab-runner
docker run --rm \
-v /gitlab-runner/config:/etc/gitlab-runner/config \
-it gitlab/gitlab-runner register</code></pre><p>register 과정에서 깃랩 프로젝트 내에서 생성된 gitlab runner token값과 코디네이션 url을(ex. <a href="https://gilab.mycompany.com/ci" rel="external nofollow noopener noreferrer" target="_blank">https://gilab.mycompany.com/ci</a>) 넣어줘야한다. 그러면 볼륨 매핑한 config 디렉토리에 <code>config.toml</code>파일이 생성된다.</p>
<p>설정이 완료되고 러너가 돌아가면 깃랩 페이지에서 내가 생성한 러너가 확인 된다. 이 자체로 러너를 돌리기엔 부족할 확률이 높다. 아래와 같이 상황에 맞춰 내가 원하는 설정을 추가적으로 넣어줘야한다.</p>
<pre><code>concurrent = 1
check_interval = 0
listen_address = &quot;0.0.0.0:443&quot;

[session_server]
  listen_address = &quot;0.0.0.0:5092&quot;
  session_timeout = 1800

[[runners]]
  name = &quot;gitlab runner linux&quot;
  url = &quot;https://gitlab.mycompany.com/ci&quot;
  token = &quot;***************&quot;
  executor = &quot;docker&quot;
  [runners.custom_build_dir]
  [runners.docker]
    tls_verify = false
    pull_policy = &quot;if-not-present&quot;
    privileged = true
    disable_entrypoint_overwrite = false
    oom_kill_disable = false
    disable_cache = false
    environment = [ &quot;DOCKER_DRIVER=overlay2&quot; ]
    cache_dir = &quot;/data/volume/gitlab-runner/cache&quot;
    volumes = [&quot;/var/run/docker.sock:/var/run/docker.sock&quot;, &quot;/data/volume/gitlab-runner/builds:/builds&quot;]
    shm_size = 0
  [runners.cache]
    [runners.cache.s3]
    [runners.cache.gcs]</code></pre><h1 id="Trouble-Shooting"><a href="#Trouble-Shooting" class="headerlink" title="Trouble Shooting"></a>Trouble Shooting</h1><p>하지만 이 설정파일을 만들기까지 매우 많은 삽질이 있었다.</p>
<h4 id="도커-통신이-정상적으로-안되는-경우"><a href="#도커-통신이-정상적으로-안되는-경우" class="headerlink" title="도커 통신이 정상적으로 안되는 경우"></a>도커 통신이 정상적으로 안되는 경우</h4><p> 나는 docker로 깃랩러너를 돌린 다음에 깃랩 러너 컨테이너와 같은 층위에 다른 도커 이미지(node나 python 이미지와 같은)를 사용해서 빌드를 하고싶었다. 이 때 이미지를 불러와야하는데 계속 볼륨으로 바인딩한 도커 서비스간에 통신이 안돼서 build failure가 발생했다.</p>
<blockquote>
<p>빌드 로그</p>
</blockquote>
<pre><code class="bash">Skipping Git submodules setup
$ docker info
Client:
Debug Mode: false
Server:
errors pretty printing info
ERROR: error during connect: Get http://docker:2375/v1.40/info: dial tcp: lookup docker on 10.101.200.3:53: server misbehaving
ERROR: Job failed: exit code 1</code></pre>
<p>혹시 볼륨 바인딩에 문제가 있는건 아닐까? 싶어서 찾아봤더니 깃랩 러너가 돌아가고있는 드라이버를 따로 표기를 해줘야한다는 글이 있어서, 환경변수로 overlay2를 넣어줬더니 정상빌드 됐다. 여기서 볼륨설정을 모든 컨테이너에 적용하고싶다면 위와같이 runner.docker에 환경변수로 넣어주면된다. 프로젝트별로 바인딩 하고싶다면 variable값으로 <code>.gitlab-ci</code> 파일에 설정해주면 된다.</p>
<pre><code>variables:
    DOCKER_DRIVER: overlay2</code></pre><h4 id="npm-프록시-세팅하기"><a href="#npm-프록시-세팅하기" class="headerlink" title="npm 프록시 세팅하기"></a>npm 프록시 세팅하기</h4><p>폐쇄된 네트워크이기 때문에 npm 패키지를 설치할때 proxy설정을 해줘야했다. 처음에 도커 이미지에 프록시 세팅을 하려했다. 러너를 통해 생성되는 도커이미지에 프록시를 세팅하려면 아래와 같이 <code>.gitlab-ci.yml</code>파일을 수정하면 된다.</p>
<blockquote>
<p>참고 <a href="https://docs.docker.com/network/proxy/" rel="external nofollow noopener noreferrer" target="_blank">도커 프록시 설정</a></p>
</blockquote>
<pre><code class="yaml">#.gitlab-ci.yml
image: node:13

variables:
    HTTPS_PROXY: &quot;https://registry.mycompany.com/repository/npm-group/&quot;
    HTTP_PROXY: &quot;http://registry.mycompany.com/repository/npm-group&quot;</code></pre>
<p>하지만 이렇게 하면 gitlab 코드를 받아올때도 프록시 설정이 적용되어 문제가 된다. no proxy옵션을 지정해주면 되지만, 앞으로 빌드하면서 어떤 url을 호출할지 알 수 없기 때문에 npm만 지정된 프록시로 우회하도록 설정하는게 깔끔하다. npm 자체적인 설정을 통해 가능하므로, ci 파일에 npm 프록시를 설정하는 스크립트를 넣어준다.</p>
<pre><code class="yml">before_script:
    - npm config set registry http://packages.webzen.com/repository/npm-group/</code></pre>
<p>사실 이 부분도 삽질을 조금 했다. npm config에 https_proxy라는 값을 세팅해줄 수 있는데, 여기에 세팅되는 프록시 주소는 registry 프록시가 아니라 패키지가 다운로드하는 url들의 프록시를 의미한다. <a href="https://docs.npmjs.com/misc/config" rel="external nofollow noopener noreferrer" target="_blank">공식문서</a>에 나와있는 설명은 이렇다.</p>
<blockquote>
<p>https-proxy§<br>Default: null<br>Type: url<br>A proxy to use for outgoing https requests. If the HTTPS_PROXY or https_proxy or HTTP_PROXY or http_proxy environment variables are set, proxy settings will be honored by the underlying request library.</p>
</blockquote>
<p>완성된 .gitlab-ci.yml파일은 이렇다.</p>
<pre><code class="yml">image: node:13

variables:
    CHROMEDRIVER_FILEPATH: &quot;/builds/chromedriver/chromedriver_linux64.zip&quot;

before_script:
    - npm config set registry http://registry.mycompany.com/repository/npm-group/

stages:
    - build

test_build:
    stage: build
    script:
        - echo &quot;build vue js&quot;
        - cd $CI_PROJECT_DIR/vue/somepage
        - npm i
        - npm run build
    environment:
        name: test
    tags:
        - linux-runner
    only:
    - vue-branch</code></pre>
<blockquote>
<p>공식문서/참고자료<br><a href="https://docs.gitlab.com/runner/executors/docker.html" rel="external nofollow noopener noreferrer" target="_blank">도커 executor 가이드</a><br><a href="https://docs.gitlab.com/ee/ci/docker/using_docker_images.html" rel="external nofollow noopener noreferrer" target="_blank">도커 이미지와 함께 빌드하기</a><br><a href="https://docs.gitlab.com/ee/ci/docker/using_docker_build.html" rel="external nofollow noopener noreferrer" target="_blank">도커 빌드하기</a><br><a href="https://docs.gitlab.com/runner/configuration/proxy.html" rel="external nofollow noopener noreferrer" target="_blank">깃랩 러너 프록시 가이드</a><br><a href="https://gitlab.com/gitlab-org/gitlab-ci-runner/issues/10" rel="external nofollow noopener noreferrer" target="_blank">coordinator url이란?</a><br><a href="https://gitlab.com/johandurancerdas/gitlab-cicd-tutorial" rel="external nofollow noopener noreferrer" target="_blank">참고 프로젝트</a><br><a href="https://www.youtube.com/watch?v=8h6IK9VkCQQ" rel="external nofollow noopener noreferrer" target="_blank">참고 강의</a></p>
</blockquote>

            </div>
          

    
      <footer class="post-footer">
        <div class="post-tags">
          
            <a href="/tags/docker/">docker</a>
          
            <a href="/tags/javascript/">javascript</a>
          
            <a href="/tags/node/">node</a>
          
            <a href="/tags/npm/">npm</a>
          
            <a href="/tags/gitlab/">gitlab</a>
          
            <a href="/tags/ci/">ci</a>
          
            <a href="/tags/container/">container</a>
          
        </div>

        
        
  <nav class="post-nav">
    
      <a class="prev" href="/dev-env/dev-env-2019-11-05-linux-password/">
        <i class="iconfont icon-left"></i>
        <span class="prev-text nav-default">리눅스 계정잠금 해제</span>
        <span class="prev-text nav-mobile">Prev</span>
      </a>
    
    
      <a class="next" href="/python/python-2019-10-18-window-python2/">
        <span class="next-text nav-default">window에서 python 버전 구분해서 실행하기</span>
        <span class="prev-text nav-mobile">Next</span>
        <i class="iconfont icon-right"></i>
      </a>
    
  </nav>

        
  <div class="comments" id="comments">
    
    <!--<div style="text-align:center;">
        <button class="btn" id="load-disqus" onclick="disqus.load();">load Disqus review</button>
    </div>-->
      <div id="disqus_thread">
        <noscript>
          Please enable JavaScript to view the
          <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a>
        </noscript>
      </div>
    
  </div>


      </footer>
    
  </article>

    </div>

      </div>

      <footer id="colophon"><span class="copyright-year">
    
        &copy;
    
    2020
    <span class="footer-author">Park Doyeon.</span>
    <span class="power-by">
        Powered by <a class="hexo-link" href="https://hexo.io/" rel="external nofollow noopener noreferrer" target="_blank">Hexo</a> and <a class="theme-link" href="https://github.com/parkdoyeon">Me</a>
    </span>
</span>

      </footer>

      <div class="back-to-top" id="back-to-top">
        <i class="iconfont icon-up"></i>
      </div>
    </div>
    

<script type="text/javascript">
  var disqus_shortname = 'parkdoyeon';
  var disqus_identifier = 'javascript/javascript-2019-10-28-gitlab-ci-docker/';
  var disqus_url = 'https://parkdoyeon.github.io/javascript/javascript-2019-10-28-gitlab-ci-docker/index.html';

  
  var disqus_config = function () {
      this.page.url = disqus_url;
      this.page.identifier = disqus_identifier;
  };
  
  (function() { // DON'T EDIT BELOW THIS LINE
    var d = document, s = d.createElement('script');
    s.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
  })();
  
  
  // var disqus = {
  //   load : function disqus(){
  //       if(typeof DISQUS !== 'object') {
  //         (function () {
  //         var s = document.createElement('script'); s.async = true;
  //         s.type = 'text/javascript';
  //         s.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  //         (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
  //         }());
  //         $('#load-disqus').remove(); ///Delete Button
  //       }
  //   }
  // }

</script>


    




  
    <script type="text/javascript" src="/lib/jquery/jquery-3.1.1.min.js"></script>
  

  

    <script src="/js/src/theme.js?v="></script>
<script src="/js/src/bootstrap.js?v="></script>


    <script src="//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML"></script>


<script src="/js/src/highlight.pack.js?v="></script>

<script src="//cdnjs.cloudflare.com/ajax/libs/highlightjs-line-numbers.js/2.7.0/highlightjs-line-numbers.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', (event) => {
  document.querySelectorAll('figure.highlight').forEach((block) => {
    hljs.highlightBlock(block);
  });
});
hljs.initHighlightingOnLoad();
hljs.initLineNumbersOnLoad();
</script><!-- hexo-inject:begin --><!-- hexo-inject:end -->
  </body>
</html>
