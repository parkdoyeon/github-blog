{"componentChunkName":"component---src-templates-post-js","path":"/elastic-search-도커를-이용해-인덱스-주기적으로-삭제하기","result":{"data":{"markdownRemark":{"html":"<p>로그를 끊임없이 ES에 저장하다보면 디스크 용량이 부족한 문제가 발생한다.<br>\n수동으로 인덱스를 삭제하다보면 단순히 번거로울 뿐만이 아니라 삭제하지 않으려고 했던 인덱스도 삭제될 수 있기 때문에, 삭제 자동화는 ES 운영에 반드시 필요하다.<br>\ncurator는 elasticsearch의 인덱스를 관리를 위한 어플리케이션으로, ES와 격리된 환경에서 http 통신으로 동작이 가능하다.</p>\n<p>여기에는 인덱스 삭제만 나와있지만, 샤드의 삭제나 엘라스틱서치의 스냅샷 삭제, 샤드 라우팅 변경도 가능하다.\n나의 경우 curator를 세팅할 서버는 폐쇄된 환경이었기 때문에,\n로컬에서 curator 공식사이트의 dockerfile을 받아 이미지를 빌드한 다음,\n이미지를 파일로 압축해 서버에 세팅하고 cronjob을 통해 매일 인덱스 삭제작업을 진행하도록 했다.</p>\n<h4 id=\"docker-image-빌드\"><a href=\"#docker-image-%EB%B9%8C%EB%93%9C\" aria-label=\"docker image 빌드 permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>docker image 빌드</h4>\n<p>github에 올라와있는 dockerfile을 다운받아 빌드한다 <a href=\"https://github.com/elastic/curator\">https://github.com/elastic/curator</a></p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">docker build <span class=\"token builtin class-name\">.</span></code></pre></div>\n<h4 id=\"큐레이터-기본-설정파일-생성하기-curatoryml\"><a href=\"#%ED%81%90%EB%A0%88%EC%9D%B4%ED%84%B0-%EA%B8%B0%EB%B3%B8-%EC%84%A4%EC%A0%95%ED%8C%8C%EC%9D%BC-%EC%83%9D%EC%84%B1%ED%95%98%EA%B8%B0-curatoryml\" aria-label=\"큐레이터 기본 설정파일 생성하기 curatoryml permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>큐레이터 기본 설정파일 생성하기: curator.yml</h4>\n<div class=\"gatsby-highlight\" data-language=\"yml\"><pre class=\"language-yml\"><code class=\"language-yml\"><span class=\"token key atrule\">client</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">hosts</span><span class=\"token punctuation\">:</span>\n   <span class=\"token punctuation\">-</span> elasticsearch\n  <span class=\"token key atrule\">port</span><span class=\"token punctuation\">:</span> <span class=\"token number\">9200</span>\n  <span class=\"token key atrule\">url_prefix</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">use_ssl</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">False</span>\n  <span class=\"token key atrule\">certificate</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">client_cert</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">client_key</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">ssl_no_validate</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">False</span>\n<span class=\"token key atrule\">cover</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"\"</span>\n  <span class=\"token key atrule\">http_auth</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">timeout</span><span class=\"token punctuation\">:</span> <span class=\"token number\">30</span>\n  <span class=\"token key atrule\">master_only</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">False</span>\n\n<span class=\"token key atrule\">logging</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">loglevel</span><span class=\"token punctuation\">:</span> INFO\n  <span class=\"token key atrule\">logfile</span><span class=\"token punctuation\">:</span> /volume/curator.log <span class=\"token comment\">#로그 디렉토리 설정, 어플리케이션 수행 </span>\n  <span class=\"token key atrule\">logformat</span><span class=\"token punctuation\">:</span> default\n  <span class=\"token key atrule\">blacklist</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'elasticsearch'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'urllib3'</span><span class=\"token punctuation\">]</span></code></pre></div>\n<h4 id=\"인덱스-삭제-규칙파일-생성하기-delete-indicesyml\"><a href=\"#%EC%9D%B8%EB%8D%B1%EC%8A%A4-%EC%82%AD%EC%A0%9C-%EA%B7%9C%EC%B9%99%ED%8C%8C%EC%9D%BC-%EC%83%9D%EC%84%B1%ED%95%98%EA%B8%B0-delete-indicesyml\" aria-label=\"인덱스 삭제 규칙파일 생성하기 delete indicesyml permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>인덱스 삭제 규칙파일 생성하기: delete-indices.yml</h4>\n<div class=\"gatsby-highlight\" data-language=\"yml\"><pre class=\"language-yml\"><code class=\"language-yml\"><span class=\"token key atrule\">actions</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">1</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">action</span><span class=\"token punctuation\">:</span> delete_indices\n    <span class=\"token key atrule\">options</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">ignore_empty_list</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">True</span>\n      <span class=\"token key atrule\">disable_action</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">False</span>\n    <span class=\"token key atrule\">filters</span><span class=\"token punctuation\">:</span>\n     <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">filtertype</span><span class=\"token punctuation\">:</span> pattern\n       <span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> prefix\n       <span class=\"token key atrule\">value</span><span class=\"token punctuation\">:</span> kr<span class=\"token punctuation\">-</span>*<span class=\"token punctuation\">-</span>\n     <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">filtertype</span><span class=\"token punctuation\">:</span> age\n       <span class=\"token key atrule\">source</span><span class=\"token punctuation\">:</span> name\n       <span class=\"token key atrule\">direction</span><span class=\"token punctuation\">:</span> older\n       <span class=\"token key atrule\">timestring</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'%Y.%m.%d'</span>\n       <span class=\"token key atrule\">unit</span><span class=\"token punctuation\">:</span> days\n       <span class=\"token key atrule\">unit_count</span><span class=\"token punctuation\">:</span> <span class=\"token number\">8 </span><span class=\"token comment\">#생성한지 8일이 된 데이터는 삭제한다</span></code></pre></div>\n<h4 id=\"도커-컴포즈-설정\"><a href=\"#%EB%8F%84%EC%BB%A4-%EC%BB%B4%ED%8F%AC%EC%A6%88-%EC%84%A4%EC%A0%95\" aria-label=\"도커 컴포즈 설정 permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>도커 컴포즈 설정</h4>\n<p>빌드된 이미지의 entrypoint는 아무 옵션 없이 단순히 어플리케이션을 실행하는 'curator/curator'이다.\n때문에 설정파일이나 규칙들을 정의해주고싶다면 아래와 같이 entrypoint override를 해야한다.\n또한, 어떤 인덱스가 삭제될지 확인하고싶다면 dry run 옵션을 통해 위의 curator.yml에 지정한 log파일에서 리스트확인이 가능하다.\n최초 실행시 반드시 dry run을 통해 curator.log에 삭제 대상이 되는 인덱스들을 확인하자.</p>\n<div class=\"gatsby-highlight\" data-language=\"yml\"><pre class=\"language-yml\"><code class=\"language-yml\"><span class=\"token key atrule\">version</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'3.3'</span>\n\n  <span class=\"token key atrule\">services</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">curator</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> curator<span class=\"token punctuation\">:</span><span class=\"token number\">5.6</span>\n      <span class=\"token key atrule\">container_name</span><span class=\"token punctuation\">:</span> curator\n      <span class=\"token key atrule\">user</span><span class=\"token punctuation\">:</span> $USER\n      <span class=\"token key atrule\">volumes</span><span class=\"token punctuation\">:</span>\n        <span class=\"token punctuation\">-</span> /data/volume/curator<span class=\"token punctuation\">:</span>/volume\n  <span class=\"token comment\"># 테스트시 주석 해제 후 실행</span>\n  <span class=\"token comment\">#    entrypoint: [\"curator/curator\", \"--config\", \"/volume/config/curator.yml\", \"--dry-run\", \"/volume/config/delete-indices.yml\"]</span>\n      <span class=\"token key atrule\">entrypoint</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"curator/curator\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"--config\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"/volume/config/curator.yml\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"/volume/config/delete-indices.yml\"</span><span class=\"token punctuation\">]</span>\n      <span class=\"token key atrule\">network_mode</span><span class=\"token punctuation\">:</span> esmaster <span class=\"token comment\">#엘라스틱 서치가 있는 네트워크와 맞춰주기</span></code></pre></div>\n<h4 id=\"큐레이터로-도커컴포즈-실행하기\"><a href=\"#%ED%81%90%EB%A0%88%EC%9D%B4%ED%84%B0%EB%A1%9C-%EB%8F%84%EC%BB%A4%EC%BB%B4%ED%8F%AC%EC%A6%88-%EC%8B%A4%ED%96%89%ED%95%98%EA%B8%B0\" aria-label=\"큐레이터로 도커컴포즈 실행하기 permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>큐레이터로 도커컴포즈 실행하기</h4>\n<p>도커 컨테이너는 규칙 실행후 exit code 0을 반환하며 종료된다.\n정기적으로 실행되도록 설정하려면 리눅스 cronjob 등록을 해줘야한다.</p>\n<ol>\n<li>\n<p>도커 컴포즈 실행 스크립트 만들기</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token shebang important\">#!/bin/bash</span>\n<span class=\"token builtin class-name\">cd</span> /path/to/docker-compose\ndocker-compose up</code></pre></div>\n</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">2. 크론탭 에디터 열기\n``` bash\ncrontab -e</code></pre></div>\n<ol start=\"3\">\n<li>\n<p>규칙 추가\n매일 17시에 실행되고, cronjob 작업 수행 이력이 crontab.log에 남는다.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token number\">0</span> <span class=\"token number\">17</span> * * * /data/volume/curator-run.sh <span class=\"token operator\">></span> /data/crontab.log <span class=\"token operator\"><span class=\"token file-descriptor important\">2</span>></span><span class=\"token file-descriptor important\">&amp;1</span></code></pre></div>\n</li>\n</ol>\n<p>완료후 반영은 wq를 통해 하면 된다.</p>","timeToRead":3,"excerpt":"로그를 끊임없이 ES에 저장하다보면 디스크 용량이 부족한 문제가 발생한다. 수동으로 인덱스를 삭제하다보면 단순히 번거로울 뿐만이 아니라 삭제하지 않으려고 했던 인덱스도 삭제될 수 있기 때문에, 삭제 자동화는 ES 운영에 반드시 필요하다. curator…","frontmatter":{"title":"ElasticSearch - 도커를 이용해 인덱스 주기적으로 삭제하기","cover":"","date":"2019-04-02T17:35:00.000Z","categories":["ELK"],"tags":["elasticsearch","docker","curator","index"]},"fields":{"slug":"/elastic-search-도커를-이용해-인덱스-주기적으로-삭제하기","date":"April 01, 2019"}}},"pageContext":{"slug":"/elastic-search-도커를-이용해-인덱스-주기적으로-삭제하기","nexttitle":"Docker 이미지/컨테이너 파일로 저장하고 불러오기","nextslug":"/docker-이미지-컨테이너-파일로-저장하고-불러오기","prevtitle":"Git - 실수로 용량이 큰 파일을 커밋했을 때","prevslug":"/git-실수로-용량이-큰-파일을-커밋했을-때"}}}