{"componentChunkName":"component---src-templates-post-js","path":"/elastic-search-unassigned-shard-문제-해결-3-replica-숫자가-부적절할때","result":{"data":{"markdownRemark":{"html":"<p>엘라스틱서치 테스트 환경에서 일어난 일이다. 마스터노드 1대만 단독으로 서비스가 올라가있는데, 어느 시점부터(아마도 es 버전을 올린 시점부터) index health status가 yellow로 바뀌었다. 확인해보니, 모든 인덱스에서 replica shard만 할당이 되지 못하고 있었다. 이유를 쿼리했더니 동일한 샤드가 있는 곳엔 샤드할당이 되지않는다는 에러메세지가 나왔다.</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\">GET /_cluster/allocation/explain\n<span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">//...생략</span>\n    cannot allocate because allocation is not permitted to any of the nodes that hold an in-sync shard copy\n    <span class=\"token comment\">//...생략</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>좀 더 찾아보니, 스택오버플로우에 <a href=\"https://stackoverflow.com/questions/37302611/elasticsearch-doesnt-allow-to-allocate-unassigned-shard\">나와 비슷한 상황</a>인 사람이 있었다. replica는 말그대로 복제 샤드이기 때문에 동일한 노드에 배치될 수 없고, 또 다른 노드에 배치되어야 한다는 답변이 있었다. 즉, 복제샤드가 필요하면 노드를 추가 해야하고, 아니면 복제샤드 갯수 설정을 더 낮게 바꿔야한다는 것이다. </p>\n<p>복제 샤드를 올바르게 설정하려면 \"전체 노드 갯수 >원본샤드 노드(1) + 복제샤드 갯수\"가 성립해야 한다. ES가 기본값으로 설정하는 샤드의 갯수는 5개, 복제 샤드의 갯수는 1개이다. 테스트환경처럼 단독으로 ES 노드를 운영하는 상황에서는 복제샤드의 갯수를 0으로 맞춰줘야 status를 green으로 유지할 수 있다.</p>\n<p>다행히도 복제샤드에 대한 설정은 이미 생성된 인덱스에도 적용할 수 있다. 다음과같이 쿼리하면 된다.</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\">PUT /index_name_*/_settings\n<span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"index\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"number_of_replicas\"</span><span class=\"token operator\">:</span> <span class=\"token number\">0</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>그리고, 앞으로 생성될 인덱스에 일괄적용하고싶다면 아래와 같이 <a href=\"/elk/elk-2019-02-27-es-mapping\">템플릿을 통해</a> 지정하면 된다.</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\">GET _template/myindex_shards_control\n<span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"index_patterns\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"index_name_*\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"settings\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"number_of_shards\"</span><span class=\"token operator\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"number_of_replicas\"</span><span class=\"token operator\">:</span> <span class=\"token number\">0</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>","timeToRead":1,"excerpt":"엘라스틱서치 테스트 환경에서 일어난 일이다. 마스터노드 1대만 단독으로 서비스가 올라가있는데, 어느 시점부터(아마도 es 버전을 올린 시점부터) index health status가 yellow로 바뀌었다. 확인해보니, 모든 인덱스에서 replica…","frontmatter":{"title":"ElasticSearch - unassigned shard 문제 해결 (3) replica 숫자가 부적절할때","cover":"","date":"2019-06-27T16:47:13.000Z","categories":["ELK"],"tags":["elasticsearch"]},"fields":{"slug":"/elastic-search-unassigned-shard-문제-해결-3-replica-숫자가-부적절할때","date":"June 26, 2019"}}},"pageContext":{"slug":"/elastic-search-unassigned-shard-문제-해결-3-replica-숫자가-부적절할때","nexttitle":"Docker 로그로 서버 용량이 꽉찼을 때","nextslug":"/docker-로그로-서버-용량이-꽉찼을-때","prevtitle":"ElasticSearch 7.2에 한국어 분석기 Nori 플러그인 설치하기","prevslug":"/elastic-search-7-2-에-한국어-분석기-nori-플러그인-설치하기"}}}